#!/bin/bash

settingsDatabase="/data/data/com.android.providers.settings/databases/settings.db"

declare -A settingTable=(
   ["country"]="property territory persist.sys.country"
   ["language"]="property language persist.sys.language"

   ["accessibility"]="database boolean accessibility_enabled secure"
   ["foreign"]="database boolean install_non_market_apps secure"
   ["nolock"]="database boolean lockscreen.disabled secure"

   ["timeout"]="database integer screen_off_timeout system"

   ["brltty"]="accessibility boolean org.a11y.brltty.android.BrailleService org.a11y.brltty.android"
   ["spiel"]="accessibility boolean info.spielproject.spiel.SpielService info.spielproject.spiel"
   ["talkback"]="accessibility boolean .TalkBackService com.google.android.marvin.talkback"
)

programName="${0##*/}"
programMessage() {
   local message="${1}"

   echo >&2 "${programName}: ${message}"
}

syntaxError() {
   local message="${1}"

   programMessage "${message}"
   exit 2
}

semanticError() {
   local message="${1}"

   programMessage "${message}"
   exit 3
}

execute() {
   adb shell "${@}"
}

sqlite3() {
   local command="${1}"

   execute sqlite3 "${settingsDatabase}" "${command}"
}

getValue() {
   local table="${1}"
   local property="${2}"

   sqlite3 "select value from ${table} where name=\"${property}\""
}

setValue() {
   local table="${1}"
   local property="${2}"
   local value="${3}"

   sqlite3 "update ${table} set value="\"${value}\"" where name=\"${property}\""
}

showSetting_database() {
   getValue "${settingContainer}" "${settingObject}"
}

changeSetting_database() {
   setValue "${settingContainer}" "${settingObject}" "${settingValue}"
}

getEnabledAccessibilityServices() {
   local services="$(getValue secure enabled_accessibility_services)"
   enabledAccessibilityServices=( ${services//:/ } )
}

testEnabledAccessibilityService() {
   local service
   local package

   for service in "${enabledAccessibilityServices[@]}"
   do
      package="${service%%/*}"
      [ "${package}" != "${settingContainer}" ] || return 0
   done

   return 1
}

showSetting_accessibility() {
   getEnabledAccessibilityServices
   local enabled=1
   testEnabledAccessibilityService || enabled=0
   echo "${enabled}"
}

showSetting_property() {
   execute getprop "${settingObject}"
}

changeSetting_property() {
   execute setprop "${settingObject}" "${settingValue}"
}

verifyValue_boolean() {
   if [[ "${settingValue}" =~ ^(0|off|false)$ ]]
   then
      settingValue=0
   elif [[ "${settingValue}" =~ ^(1|on|true)$ ]]
   then
      settingValue=1
   else
      return 1
   fi

   return 0
}

verifyValue_integer() {
   [[ "${settingValue}" =~ ^(0|1[0-9]*)$ ]] || return 1
   return 0
}

verifyValue_language() {
   [ "${#settingValue}" -ne 2 ] || {
      [ "${settingValue,,*}" != "${settingValue}" ] || {
         return 0
      }
   }

   return 1
}
verifyValue_territory() {
   [ "${#settingValue}" -ne 2 ] || {
      [ "${settingValue^^*}" != "${settingValue}" ] || {
         return 0
      }
   }

   return 1
}

useEmulator=false
deviceSerialNumber=""

while getopts ":d:e" option
do
   case "${option}"
   in
      :) syntaxError "missing option value: -${OPTARG}";;
     \?) syntaxError "unknown option: -${OPTARG}";;
      *) syntaxError "unimplemented option: -${option}";;
   esac
done
shift $((OPTIND - 1))

[ "${#}" -gt 0 ] || syntaxError "missing setting name"
settingName="${1}"
shift 1

settingDescriptor="${settingTable["${settingName}"]}"
[ -n "${settingDescriptor}" ] || syntaxError "unknown setting name: ${settingName}";
settingAttributes=( ${settingDescriptor} )
settingClass="${settingAttributes[0]}"
settingType="${settingAttributes[1]}"
settingObject="${settingAttributes[2]}"
settingContainer="${settingAttributes[3]}"

[ "${#}" -gt 0 ] || {
   "showSetting_${settingClass}"
   exit 0
}

settingValue="${1}"
shift 1
[ "${#}" -eq 0 ] || syntaxError "too many parameters"

"verifyValue_${settingType}" || syntaxError "invalid setting value: ${settingName}=${settingValue}"
exit 0
"changeSetting_${settingClass}"
exit 0
