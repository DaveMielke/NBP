#!/system/bin/sh
exec >"/data/local/tmp/${0##*/}.log" 2>&1

log() {
  local message="${1}"

  echo >&2 "`date +%Y-%m-%d@%H:%M:%S` ${message}"
}

hostCommand() {
# log "host command: ${*}"
  "${@}"
}

sqlCommand() {
  local command="${1}"

  hostCommand sqlite3 "/data/data/com.android.providers.settings/databases/settings.db" "${command}"
}

getField() {
  local table="${1}"
  local name="${2}"

  sqlCommand "select value from ${table} where name=\"${name}\""
}

setField() {
  local table="${1}"
  local name="${2}"
  local newValue="${3}"

  oldValue="$(getField "${table}" "${name}")"
  log "checking field: ${table}.${name}: ${oldValue}"

  [ "${oldValue}" = "${newValue}" ] || {
    log "setting field: ${table}.${name} = ${newValue}"
    sqlCommand "insert into ${table} (name, value) values (\"${name}\", \"${newValue}\")"
  }
}

getProperty() {
  local name="${1}"

  hostCommand getprop "${name}"
}

setProperty() {
  local name="${1}"
  local newValue="${2}"

  oldValue="$(getProperty "${name}")"
  log "checking property: ${name}: ${oldValue}"

  [ "${oldValue}" = "${newValue}" ] || {
    log "setting property: ${name} = ${newValue}"
    hostCommand setprop "${name}" "${newValue}"
  }
}

getPermission() {
  local path="${1}"

  hostCommand stat -c "%a" "${path}"
}

setPermission() {
  local path="${1}"
  local newValue="${2}"

  oldValue="$(getPermission "${path}")"
  log "checking permission: ${path}: ${oldValue}"

  [ "${oldValue}" = "${newValue}" ] || {
    log "setting permission: ${path} = ${newValue}"
    hostCommand chmod "${newValue}" "${path}"
  }
}

permitEventDevice() {
  local identifier="${1}"
  set -- `ls /sys/bus/platform/devices/${identifier}/input*`

  [ "${#}" -eq 1 ] && {
    local name="${1##*/}"
    local event="${name#input}"

    [ -n "${event}" ] && {
      local device="/dev/input/event${event}"
      log "permitting event device: ${identifier}"
      setPermission "${device}" 666
    }
  }
}

# enable ADB (the Android Debug Bridge)
setProperty persist.service.adb.enable 1
setField secure adb_enabled 1

# enable power switch monitoring
permitEventDevice twl4030_pwrbutton

# enable keyboard monitoring
permitEventDevice cp430_keypad

# enable key event injection
chmod 666 /dev/uinput

# enable the braille device
chmod 666 /dev/braille0

# disable scren locking
setField secure lockscreen.disabled 1

# set the screen off timeout to 30 minutes (in milliseconds)
setField system screen_off_timeout 1800000

# enable the installation of packages from foreign sources
setField secure install_non_market_apps 1

# enable the developer settings screen
setField secure development_settings_enabled 1

# enable accessibility services
setField secure accessibility_enabled 1

# wait for booting to finish
log "waiting for boot to complete"
while [ "`getprop sys.boot_completed`" != "1" ]
do
  sleep 5
done
log "boot completed"

log "setting input method"
package="org.nbp.b2g.ui"
component="${package}/.InputService"
hostCommand ime enable "${component}" &&
hostCommand ime set "${component}"

log "done"
exit 0
