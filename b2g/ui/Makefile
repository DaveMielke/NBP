all: apk

APPLICATION_NAME = UserInterface
PACKAGE_PATH = org.nbp.b2g.ui
PLATFORM_NAME = armeabi

JNI_SOURCES := Android.mk
JNI_SOURCES += utils.h
JNI_SOURCES += utils.c
JNI_SOURCES += uinput.c
JNI_SOURCES += keyboard.c
JNI_SOURCES += kbdmon.c
JNI_SOURCES += metec_flat20_ioctl.h
JNI_SOURCES += brldev.c

ANDROID_JNI_DIRECTORY = jni
ANDROID_ASSETS_DIRECTORY = assets
ANDROID_BINARIES_DIRECTORY = bin
ANDROID_LIBRARIES_DIRECTORY = libs

ANDROID_PROJECT_NAME = NBP_B2G_$(APPLICATION_NAME)
ANDROID_PLATFORM_DIRECTORY = $(ANDROID_LIBRARIES_DIRECTORY)/$(PLATFORM_NAME)

SIGNING_PROPERTIES_FILE = signing.properties
ANDROID_BUILD_MODE := $(strip $(if $(wildcard $(SIGNING_PROPERTIES_FILE)), release, debug))
show-build-mode:
	@echo $(ANDROID_BUILD_MODE)

ANDROID_JNI_SOURCES := $(JNI_SOURCES:%=$(ANDROID_JNI_DIRECTORY)/%)
ANDROID_NATIVE_LIBRARY = $(ANDROID_PLATFORM_DIRECTORY)/lib$(APPLICATION_NAME).so
jni: $(ANDROID_NATIVE_LIBRARY)
$(ANDROID_NATIVE_LIBRARY): $(ANDROID_JNI_SOURCES)
	ndk-build

ANDROID_LOCAL_PROPERTIES = local.properties
ANDROID_LOCAL_FILES := $(ANDROID_LOCAL_PROPERTIES)
$(ANDROID_LOCAL_PROPERTIES): FORCE
	android update project --path .

ANDROID_BUILD_REVISION = $(ANDROID_ASSETS_DIRECTORY)/build.revision
ANDROID_LOCAL_FILES += $(ANDROID_BUILD_REVISION)
$(ANDROID_BUILD_REVISION): FORCE
	git describe --always >$@

ANDROID_BUILD_TIME = $(ANDROID_ASSETS_DIRECTORY)/build.time
ANDROID_LOCAL_FILES += $(ANDROID_BUILD_TIME)
$(ANDROID_BUILD_TIME): FORCE
	date --utc --iso-8601=seconds >$@

ANDROID_PROJECT_PACKAGE = $(ANDROID_BINARIES_DIRECTORY)/$(ANDROID_PROJECT_NAME)-$(ANDROID_BUILD_MODE).apk
apk: $(ANDROID_PROJECT_PACKAGE)
$(ANDROID_PROJECT_PACKAGE): jni $(ANDROID_LOCAL_FILES) AndroidManifest.xml
	ant $(ANDROID_BUILD_MODE)

clean::
	-rm -f $(ANDROID_LOCAL_FILES)
	-rm -f -r $(ANDROID_BINARIES_DIRECTORY)
	-rm -f -r $(ANDROID_LIBRARIES_DIRECTORY)
	-rm -f -r gen

install: all
	adb install $(ANDROID_PROJECT_PACKAGE)

reinstall: all
	adb install -r $(ANDROID_PROJECT_PACKAGE)

uninstall:
	adb uninstall $(PACKAGE_PATH)

FORCE:

