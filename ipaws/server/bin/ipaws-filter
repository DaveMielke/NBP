#!/bin/bash

. "${0%/*}/prologue.sh"
includeScriptLibraries command arguments xml time

showCommandSpecificOptionsUsageSummary() {
cat <<END-OF-COMMAND-SPECIFIC-OPTIONS-USAGE-SUMMARY
-c path        the configuration directory (default is ${defaultConfigurationDirectory})
-d path        the data directory (default is ${defaultDataDirectory})
-R             remove the files that are rejected by the filter

If no alert files are specified then all of them are analyzed.
END-OF-COMMAND-SPECIFIC-OPTIONS-USAGE-SUMMARY
}

configurationDirectory=""
handleCommandOption_c() {
   configurationDirectory="${OPTARG}"
}

dataDirectory=""
handleCommandOption_d() {
   dataDirectory="${OPTARG}"
}

removeFiles=false
handleCommandOption_R() {
   removeFiles=true
}

handlePositionalCommandArguments() {
   alertFiles=("${@}")
}

rejectAlert() {
   local file="${1}"

   local sentTime="$(xpathGet "${file}" "/alert/sent/text()")"
   [ -n "${sentTime}" ] || {
      logInfo "no sent time: ${file}"
      return 0
   }

   [ "$(xpathGet "${file}" "count(/alert/info)")" = "1" ] || {
      logInfo "no info element: ${file}"
      return 0
   }

   local expiryTime="$(xpathGet "${file}" "/alert/info/expires/text()")"
   [ -n "${expiryTime}" ] || {
      local effectiveTime="$(xpathGet "${file}" "/alert/info/effective/text()")"
      [ -n "${effectiveTime}" ] || effectiveTime="${sentTime}"
      expiryTime="$(utcTime "${effectiveTime} -1 day")"
   }

   local expirySeconds="$(epochSeconds "${expiryTime}")"
   [ "${expirySeconds}" -lt "${currentSeconds}" ] && {
      logInfo "expired: ${file}: ${expiryTime}"
      return 0
   }

   return 1
}

handleCommandArguments "c:d:R" "[alert-file ...]" "${@}"

[ -n "${configurationDirectory}" ] || configurationDirectory="${defaultConfigurationDirectory}"
verifyReadableDirectory "${configurationDirectory}"
logDebug "configuration-directory ${configurationDirectory}"
processConfigurationFile "${configurationDirectory}"

[ -n "${dataDirectory}" ] || dataDirectory="${defaultDataDirectory}"
verifyWritableDirectory "${dataDirectory}"
logDebug "data-directory ${dataDirectory}"

readonly currentTime="$(utcTime)"
logDebug "current-time ${currentTime}"
readonly currentSeconds="$(epochSeconds "${currentTime}")"

[ "${#alertFiles[*]}" -gt 0 ] || {
   cd "${dataDirectory}"
   alertFiles=(*".${alertFileExtension}")
}

acceptCount=0
rejectCount=0
skipCount="${#alertFiles[*]}"

for file in "${alertFiles[@]}"
do
   [ -e "${file}" ] || {
      logWarning "file not found: ${file}"
      continue
   }

   [ -f "${file}" ] || {
      logWarning "not a file: ${file}"
      continue
   }

   [ -r "${file}" ] || {
      logWarning "file not readable: ${file}"
      continue
   }

   [ "$(xpathGet "${file}" "count(/alert)")" -eq "1" ] || {
      logWarning "not an alert: ${file}"
      continue
   }

   if rejectAlert "${file}"
   then
      let rejectCount+=1

      "${removeFiles}" && {
         logInfo "removing alert file: ${file}"
         rm -f -- "${file}"
      }
   else
      let acceptCount+=1
   fi

   let skipCount-=1 || :
done

logInfo "summary: Accept:${acceptCount} Reject:${rejectCount} Skip:${skipCount}"
exit 0
