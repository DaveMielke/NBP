#!/bin/bash

. "${0%/*}/prologue.sh"
includeScriptLibraries command arguments options-common CAP xml filter

extractAlerts() {
   waitIfAlreadyRunning
   local temporaryFile="${alertFileExtension}.extracted"

   while :
   do
      set -- *.${alertsFileExtension}
      [ "${#}" -eq 0 ] && break
      local alertsFile

      for alertsFile
      do
         local alertsName="${alertsFile%.*}"
         logInfo "processing alert set: ${alertsName}"
         local alertCount="$(capGetAlertCount "${alertsFile}")"

         [ -n "${alertCount}" ] && {
            local alertNumber=0

            while (( (alertNumber += 1) <= alertCount ))
            do
               capGetAlertElement "${alertsFile}" "${alertNumber}" >"${temporaryFile}"

               local alertIdentifier="$(xmlEvaluate "${temporaryFile}" "/alert/identifier/text()")"
               local alertFile="${alertIdentifier}.${alertFileExtension}"
               [ -e "${alertFile}" ] && continue
               logInfo "new alert: ${alertIdentifier}"

               if acceptAlert "${temporaryFile}" true
               then
                  logInfo "alert accepted: ${alertIdentifier}"
                  mv -- "${temporaryFile}" "${alertFile}"
                  chmod -- a-w "${alertFile}"
               else
                  logInfo "alert rejected: ${alertIdentifier}"
               fi
            done
         }

         logInfo "removing alert set: ${alertsName}"
         rm -f -- "${alertsFile}"
      done
   done
}

handleCommandArguments "" "${@}"
prepareCommonCommandOptions

cd "${dataDirectory}"
extractAlerts
logDebug "done"
exit 0
